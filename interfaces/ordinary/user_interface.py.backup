
import os
from PyQt5 import QtCore, QtWidgets, QtGui
from sensor_driver.interfaces.ordinary.layout.layout_user import Ui_MainWindow
#
from usb.core import USBError
import sys
import numpy as np
import sys
import os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))
from sensor_driver.data_processing.data_handler import DataHandler
#
from sensor_driver.interfaces.public.utils import (set_logo,
                                              config, save_config, catch_exceptions)
from sensor_driver.interfaces.ordinary.ordinary_plot import OrdinaryPlot
import pyqtgraph as pg
#
# å¯¼å…¥æ ¡å‡†ç›¸å…³æ¨¡å—
import torch
import matplotlib.pyplot as plt
from matplotlib.backends.backend_qt5agg import FigureCanvasQTAgg as FigureCanvas
from matplotlib.figure import Figure
import matplotlib.font_manager as fm
#
AVAILABLE_FILTER_NAMES = ['æ— ', 'ä¸­å€¼-0.2s', 'ä¸­å€¼-1s', 'å‡å€¼-0.2s', 'å‡å€¼-1s', 'å•å‘æŠµæ¶ˆ-è½»', 'å•å‘æŠµæ¶ˆ-ä¸­', 'å•å‘æŠµæ¶ˆ-é‡']


class AICalibrationAdapter:
    """AIæ ¡å‡†é€‚é…å™¨"""

    def __init__(self):
        self.coeffs = None
        self.device = None
        self.is_loaded = False

    def load_calibration(self, filepath):
        """åŠ è½½AIæ ¡å‡†æ¨¡å‹"""
        try:
            if not os.path.exists(filepath):
                print(f"âŒ AIæ ¡å‡†æ–‡ä»¶ä¸å­˜åœ¨: {filepath}")
                return False

            # åŠ è½½PyTorchæ¨¡å‹
            self.coeffs = torch.load(filepath)
            print(f"âœ… æˆåŠŸåŠ è½½AIæ ¡å‡†ç³»æ•°ï¼Œå½¢çŠ¶: {self.coeffs.shape}")

            # è®¾ç½®è®¾å¤‡
            if torch.cuda.is_available():
                self.device = torch.device("cuda")
                print("âœ… ä½¿ç”¨GPUè¿›è¡ŒAIæ ¡å‡†")
            else:
                self.device = torch.device("cpu")
                print("âœ… ä½¿ç”¨CPUè¿›è¡ŒAIæ ¡å‡†")

            # å°†ç³»æ•°ç§»åˆ°æŒ‡å®šè®¾å¤‡
            self.coeffs = self.coeffs.to(self.device)
            self.is_loaded = True
            return True

        except Exception as e:
            print(f"âŒ åŠ è½½AIæ ¡å‡†æ¨¡å‹å¤±è´¥: {e}")
            return False

    def apply_calibration(self, raw_data):
        """åº”ç”¨AIæ ¡å‡†åˆ°åŸå§‹æ•°æ®"""
        if not self.is_loaded or self.coeffs is None:
            return raw_data

        try:
            # ç¡®ä¿è¾“å…¥æ˜¯64x64æ•°ç»„
            if raw_data.shape != (64, 64):
                print(f"âš ï¸ è¾“å…¥æ•°æ®å½¢çŠ¶é”™è¯¯: {raw_data.shape}ï¼ŒæœŸæœ› (64, 64)")
                return raw_data

            # è½¬æ¢ä¸ºPyTorchå¼ é‡
            raw_tensor = torch.from_numpy(raw_data).float().to(self.device)
            raw_flat = raw_tensor.view(-1)  # å±•å¹³ä¸º4096ç»´å‘é‡

            # åº”ç”¨äºŒæ¬¡å¤šé¡¹å¼æ ¡å‡†: y = a*x^2 + b*x + c
            x = raw_flat
            a = self.coeffs[:, 0]  # äºŒæ¬¡é¡¹ç³»æ•°
            b = self.coeffs[:, 1]  # ä¸€æ¬¡é¡¹ç³»æ•°
            c = self.coeffs[:, 2]  # å¸¸æ•°é¡¹

            # å¹¶è¡Œè®¡ç®—æ ¡å‡†
            calibrated_flat = a * x**2 + b * x + c

            # æ¢å¤ä¸º64x64çŸ©é˜µ
            calibrated_tensor = calibrated_flat.view(64, 64)
            calibrated_data = calibrated_tensor.cpu().numpy()

            return calibrated_data

        except Exception as e:
            print(f"âš ï¸ AIæ ¡å‡†åº”ç”¨å¤±è´¥: {e}")
            return raw_data

    def get_info(self):
        """è·å–AIæ ¡å‡†ä¿¡æ¯"""
        if not self.is_loaded:
            return None

        return {
            'is_loaded': True,
            'coeffs_shape': self.coeffs.shape if self.coeffs is not None else None,
            'device': str(self.device),
            'coeffs_range': {
                'a': [float(self.coeffs[:, 0].min()), float(self.coeffs[:, 0].max())],
                'b': [float(self.coeffs[:, 1].min()), float(self.coeffs[:, 1].max())],
                'c': [float(self.coeffs[:, 2].min()), float(self.coeffs[:, 2].max())]
            } if self.coeffs is not None else None
        }


class Window(QtWidgets.QMainWindow, Ui_MainWindow):
    """
    ä¸»çª—å£
    """


    def __init__(self, mode='standard'):
        """

        :param mode: "standard" or "socket"
        """
        super().__init__()
        self.setupUi(self)
        # é‡å®šå‘æç¤º
        sys.excepthook = self._catch_exceptions
        self.config, self.save_config = config, save_config
        #
        self.is_running = False
        #
        self.data_handler = self.__mode_selector(mode)
        self.plotter = OrdinaryPlot(self)
        self.plotter.set_using_calibration()
        # ç•Œé¢åˆå§‹é…ç½®
        self.__pre_initialize()
        self.timer = QtCore.QTimer()
        self.timer.timeout.connect(self.trigger)
        #
        self.current_db_path = None

        # æ ¡å‡†ç›¸å…³å˜é‡
        self.calibration_coeffs = None
        self.device = torch.device("cpu")
        self.setup_calibration()

    def __mode_selector(self, mode):
        if mode == 'standard':
            from backends.usb_driver import LargeUsbSensorDriver
            data_handler = DataHandler(LargeUsbSensorDriver)
        elif mode == 'can':
            from backends.can_driver import Can16SensorDriver
            data_handler = DataHandler(Can16SensorDriver)
        else:
            raise NotImplementedError()
        return data_handler

    def _catch_exceptions(self, ty, value, tb):
        catch_exceptions(self, ty, value, tb)

    def start(self):
        # æŒ‰å¼€å§‹é”®
        if not self.is_running:
            flag = self.data_handler.connect(self.com_port.text())
            self.config['port'] = self.com_port.text()
            self.save_config()
            if not flag:
                return
            self.is_running = True
            self.timer.start(self.config['trigger_time'])
            self.__set_enable_state()
            self.com_port.setEnabled(False)

    def stop(self):
        # æŒ‰åœæ­¢é”®
        self.config['y_lim'] = self.plotter.log_y_lim
        self.save_config()
        if self.is_running:
            self.is_running = False
            if self.timer.isActive():
                self.timer.stop()
            self.data_handler.disconnect()
            self.data_handler.clear()
            self.__set_enable_state()

    def __pre_initialize(self):
        set_logo(self, True)
        self.__initialize_buttons()  # åˆå§‹åŒ–ä¸€èˆ¬æ¥å£
        self.__set_enable_state()  # å„ç±»å¼€å§‹/åœæ­¢çŠ¶æ€åˆ‡æ¢æ—¶è°ƒç”¨
        self.com_port.setEnabled(True)  # ä¸€æ—¦æˆåŠŸå¼€å§‹ï¼Œå°±å†ä¹Ÿä¸èƒ½ä¿®æ”¹
        
        # ç¡®ä¿èœå•æ å¯è§
        if hasattr(self, 'menubar') and self.menubar is not None:
            self.menubar.setVisible(True)
            self.menubar.setHidden(False)
            self.menubar.raise_()
            print("ğŸ”§ å¼ºåˆ¶è®¾ç½®èœå•æ å¯è§")
            
        # å»¶è¿Ÿè®¾ç½®èœå•æ å¯è§ï¼ˆåœ¨çª—å£æ˜¾ç¤ºåï¼‰
        QtCore.QTimer.singleShot(100, self._ensure_menubar_visible)

    def __initialize_buttons(self):
        # è®¾ç½®èœå•æ 
        self.setup_calibration_menu()
        # å¼€å§‹
        self.button_start.clicked.connect(self.start)
        self.action_start.triggered.connect(self.start)
        self.button_stop.clicked.connect(self.stop)
        self.action_stop.triggered.connect(self.stop)
        #
        for name in AVAILABLE_FILTER_NAMES:
            self.combo_filter_time.addItem(name)
        current_idx_filter_time = self.config.get('filter_time_index')
        if current_idx_filter_time < self.combo_filter_time.count():
            self.combo_filter_time.setCurrentIndex(current_idx_filter_time)
        self.combo_interpolate.setCurrentIndex(self.config.get('interpolate_index'))
        self.combo_blur.setCurrentIndex(self.config.get('blur_index'))
        self.__set_filter()
        self.__set_interpolate_and_blur()
        self.combo_filter_time.currentIndexChanged.connect(self.__set_filter)
        self.combo_interpolate.currentIndexChanged.connect(self.__set_interpolate_and_blur)
        self.combo_blur.currentIndexChanged.connect(self.__set_interpolate_and_blur)
        self.__set_enable_state()
        #
        self.button_set_zero.clicked.connect(self.data_handler.set_zero)
        self.action_set_zero.triggered.connect(self.data_handler.set_zero)
        self.button_abandon_zero.clicked.connect(self.data_handler.abandon_zero)
        self.action_abandon_zero.triggered.connect(self.data_handler.abandon_zero)
        self.button_save_to.clicked.connect(self.__trigger_save_button)
        self.action_save_to.triggered.connect(self.__trigger_save_button)
        self.action_save_finish.triggered.connect(self.__trigger_save_button)

        str_port = self.config.get('port')
        if not isinstance(str_port, str):
            raise Exception('é…ç½®æ–‡ä»¶å‡ºé”™')
        self.com_port.setText(self.config['port'])
        # æ ‡å®šåŠŸèƒ½
        self.button_load_calibration.clicked.connect(self.__set_calibrator)
        self.action_load_calibration.triggered.connect(self.__set_calibrator)
        self.button_exit_calibration.clicked.connect(self.__abandon_calibrator)
        self.action_exit_calibration.triggered.connect(self.__abandon_calibrator)

        # æ·»åŠ AIæ ¡å‡†æŒ‰é’®åˆ°ç°æœ‰ç•Œé¢
        print("ğŸ”§ æ·»åŠ AIæ ¡å‡†æŒ‰é’®åˆ°ç•Œé¢...")
        try:
            # åœ¨ç°æœ‰æŒ‰é’®ä¸‹æ–¹æ·»åŠ AIæ ¡å‡†æŒ‰é’®
            from PyQt5 import QtCore
            
            # åˆ›å»ºAIæ ¡å‡†æŒ‰é’®
            self.button_ai_calibration = QtWidgets.QPushButton("AIæ ¡å‡†", self)
            self.button_ai_calibration.setGeometry(10, 200, 100, 30)  # ä¸´æ—¶ä½ç½®
            self.button_ai_calibration.clicked.connect(self.__show_ai_calibration_menu)
            self.button_ai_calibration.show()
            
            print("âœ… AIæ ¡å‡†æŒ‰é’®å·²æ·»åŠ åˆ°ç•Œé¢")
            
        except Exception as e:
            print(f"âš ï¸ æ·»åŠ AIæ ¡å‡†æŒ‰é’®å¤±è´¥: {e}")

        # å¦‚æœæ²¡æœ‰ç•Œé¢æŒ‰é’®ï¼Œå¯ä»¥é€šè¿‡èœå•é¡¹è®¿é—®
        # æˆ–è€…åœ¨å·¥å…·æ ä¸­æ·»åŠ æŒ‰é’®
        # æ’­æ”¾åŠŸèƒ½
        self.button_play.clicked.connect(self.__trigger_play_button)  # è¿æ¥æ’­æ”¾æŒ‰é’®

    def __set_enable_state(self):
        # æ ¹æ®å®é™…çš„å¼€å§‹/åœæ­¢çŠ¶æ€ï¼Œè®¾å®šå„æŒ‰é’®æ˜¯å¦æ¿€æ´»
        self.button_start.setEnabled(not self.is_running)
        self.action_start.setEnabled(not self.is_running)
        self.button_stop.setEnabled(self.is_running)
        self.action_stop.setEnabled(self.is_running)

        self.button_save_to.setEnabled(self.is_running)
        if self.data_handler.output_file:
            self.button_save_to.setText("ç»“æŸé‡‡é›†")
        else:
            self.button_save_to.setText("é‡‡é›†åˆ°...")
        self.action_save_to.setEnabled(self.is_running and not self.data_handler.saving_file)
        self.action_save_finish.setEnabled(self.is_running and self.data_handler.saving_file)
        if self.is_running:
            self.com_port.setEnabled(False)

    def __set_filter(self):
        # ä¸ºself.combo_filter_timeé€é¡¹æ·»åŠ é€‰é¡¹
        self.data_handler.set_filter("æ— ", self.combo_filter_time.currentText())
        self.config['filter_time_index'] = self.combo_filter_time.currentIndex()
        self.save_config()

    def __set_interpolate_and_blur(self):
        interpolate = int(self.combo_interpolate.currentText())
        blur = float(self.combo_blur.currentText())
        self.data_handler.set_interpolation_and_blur(interpolate=interpolate, blur=blur)
        self.config['interpolate_index'] = self.combo_interpolate.currentIndex()
        self.config['blur_index'] = self.combo_blur.currentIndex()
        self.save_config()

    def __set_calibrator(self):
        path = QtWidgets.QFileDialog.getOpenFileName(
            self, "é€‰æ‹©æ ‡å®šæ–‡ä»¶", "", "æ ‡å®šæ–‡ä»¶ (*.clb; *.csv)")[0]
        if path:
            flag = self.data_handler.set_calibrator(path)
            if flag:
                self.plotter.set_using_calibration()

    def __abandon_calibrator(self):
        self.data_handler.abandon_calibrator()
        self.plotter.set_using_calibration()

    def __trigger_save_button(self):
        if self.data_handler.output_file:
            self.data_handler.close_output_file()
        else:
            file = QtWidgets.QFileDialog.getSaveFileName(
                self,
                "é€‰æ‹©è¾“å‡ºè·¯å¾„",
                "",
                "æ•°æ®åº“ (*.db)")
            if file[0]:
                self.data_handler.link_output_file(file[0])
        self.__set_enable_state()

    # æ’­æ”¾æŒ‰é’®ï¼ˆé€‰æ‹©å¹¶è¯»å–æ•°æ®åº“æ–‡ä»¶ï¼‰
    def __trigger_play_button(self):
        # ä»…å½“æœªæ’­æ”¾æˆ–æ’­æ”¾å®Œæˆæ—¶å¼€å¯è®¡æ—¶
        if not self.data_handler.play_complete_flag:
            '''
            è°ƒç”¨äº†self.timer.start()ä»¥å¯ç”¨qtçš„triggerå¾ªç¯
            '''
            self.timer.start(self.config['trigger_time'])
            self.button_play.setText("æš‚åœ")

        # æ’­æ”¾å®Œæˆçš„é‡ç½®
        if self.data_handler.play_complete_flag:
            self.timer.stop() # ç»ˆæ­¢qtçš„triggerå¾ªç¯
            self.current_db_path = None
            self.data_handler.play_complete_flag = False

            print("æ’­æ”¾æ•°æ®å·²å®Œæˆ")
            self.button_play.setText("æ’­æ”¾")

        # å¦‚æœå½“å‰æ²¡æœ‰åŠ è½½æ•°æ®åº“ï¼Œåˆ™æ‰“å¼€æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
        if not self.current_db_path:
            file_path, _ = QtWidgets.QFileDialog.getOpenFileName(
                self,
                "é€‰æ‹©æ•°æ®åº“æ–‡ä»¶",
                "",
                "SQLite æ•°æ®åº“ (*.db);;æ‰€æœ‰æ–‡ä»¶ (*)"
            )

            if file_path:
                try:
                    # æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    print(f"æ­£åœ¨è¯»å–æ•°æ®åº“: {os.path.basename(file_path)}")
                    self.button_play.setEnabled(False)
                    QtWidgets.QApplication.processEvents()

                    # è°ƒç”¨è¯»å–æ•°æ®åº“çš„æ–¹æ³•
                    self.data_handler.read_data_from_db(file_path)

                    # æ›´æ–°çŠ¶æ€
                    print(f"å·²åŠ è½½æ•°æ®åº“: {os.path.basename(file_path)}")
                    self.data_handler.play_flag = True
                    self.current_db_path = file_path


                except Exception as e:
                    # é”™è¯¯å¤„ç†
                    print(f"è¯»å–æ•°æ®åº“å¤±è´¥: {str(e)}")
                    QtWidgets.QMessageBox.critical(self, "é”™è¯¯", f"æ— æ³•è¯»å–æ•°æ®åº“:\n{str(e)}")
                finally:
                    # æ¢å¤æŒ‰é’®çŠ¶æ€
                    self.button_play.setEnabled(True)
                    self.__set_enable_state()

        else:
            # å¦‚æœå·²ç»åŠ è½½äº†æ•°æ®åº“ï¼Œåˆ™åˆ‡æ¢æ’­æ”¾çŠ¶æ€
            self.data_handler.play_flag = not self.data_handler.play_flag

            # æ›´æ–°æŒ‰é’®æ–‡æœ¬ä»¥åæ˜ å½“å‰çŠ¶æ€
            if self.data_handler.play_flag:
                print("å·²å¼€å§‹æ’­æ”¾æ•°æ®")
                self.button_play.setText("æš‚åœ")
            else:
                print("å·²æš‚åœæ’­æ”¾æ•°æ®")
                self.button_play.setText("ç»§ç»­æ’­æ”¾")

            self.__set_enable_state()


    def trigger(self):
        try:
            self.data_handler.trigger()

            # å¦‚æœæœ‰AIæ ¡å‡†æ¨¡å‹ï¼Œå¯¹æœ€æ–°æ•°æ®åº”ç”¨AIæ ¡å‡†
            if self.calibration_coeffs is not None and len(self.data_handler.value) > 0:
                latest_raw_data = self.data_handler.value[-1]

                # ä¿å­˜åŸå§‹æ•°æ®å‰¯æœ¬ï¼ˆç”¨äºå¯¹æ¯”ï¼‰
                if not hasattr(self, '_raw_data_for_comparison'):
                    self._raw_data_for_comparison = []
                
                # ä¿æŒæœ€è¿‘10å¸§çš„åŸå§‹æ•°æ®
                self._raw_data_for_comparison.append(latest_raw_data.copy())
                if len(self._raw_data_for_comparison) > 10:
                    self._raw_data_for_comparison.pop(0)

                # åº”ç”¨AIæ ¡å‡†
                calibrated_data = self.apply_ai_calibration(latest_raw_data)

                # å°†æ ¡å‡†åçš„æ•°æ®æ›¿æ¢åˆ°data_handlerä¸­
                if len(self.data_handler.value) > 0:
                    self.data_handler.value[-1] = calibrated_data

                # ä¸è¦ä¿®æ”¹value_before_zeroï¼Œä¿æŒå®ƒä¸ºåŸå§‹æ•°æ®
                # åªä¿®æ”¹filtered_dataï¼Œå› ä¸ºå®ƒç”¨äºæ˜¾ç¤º
                if len(self.data_handler.filtered_data) > 0:
                    self.data_handler.filtered_data[-1] = calibrated_data

            self.plotter.trigger()
            self.console_out.setText(self.get_console_str())

        except USBError:
            self.stop()
            QtWidgets.qApp.quit()
        except Exception as e:
            # self.stop()
            raise e

    def trigger_null(self):
        self.plotter.trigger_null()

    def closeEvent(self, a0: QtGui.QCloseEvent) -> None:
        self.stop()
        super(Window, self).closeEvent(a0)
        sys.exit()

    def get_console_str(self):
        if self.is_running:
            if self.data_handler.saving_file:
                ret = 'é‡‡é›†ä¸­...'
            else:
                ret = 'å·²è¿æ¥'
                if self.data_handler.tracing_points:
                    ret += f' è¿½è¸ªç‚¹ {self.data_handler.tracing_points}'
        else:
            ret = 'æœªè¿æ¥'

        # æ·»åŠ æ ¡å‡†çŠ¶æ€ä¿¡æ¯
        calibration_status = []
        if hasattr(self.data_handler, 'using_calibration') and self.data_handler.using_calibration:
            calibration_status.append('ä¼ ç»Ÿæ ¡å‡†')
        if hasattr(self.data_handler, 'using_balance_calibration') and self.data_handler.using_balance_calibration:
            calibration_status.append('å¹³è¡¡æ ¡å‡†')
        if self.calibration_coeffs is not None:
            calibration_status.append('AIæ ¡å‡†')

        if calibration_status:
            ret += f' | æ ¡å‡†: {", ".join(calibration_status)}'

        return ret

    # ==================== AIæ ¡å‡†åŠŸèƒ½ ====================

    def setup_calibration(self):
        """è®¾ç½®AIæ ¡å‡†åŠŸèƒ½"""
        if torch.cuda.is_available():
            self.device = torch.device("cuda")
            print("AIæ ¡å‡†å°†ä½¿ç”¨GPUåŠ é€Ÿ")
        else:
            self.device = torch.device("cpu")
            print("AIæ ¡å‡†å°†ä½¿ç”¨CPU")

    def __load_ai_calibration(self):
        """åŠ è½½AIæ ¡å‡†æ¨¡å‹"""
        try:
            # å°è¯•ä»å½“å‰ç›®å½•åŠ è½½
            current_dir = os.getcwd()
            coeffs_path = os.path.join(current_dir, 'calibration_coeffs.pt')

            if not os.path.exists(coeffs_path):
                # å¦‚æœä¸å­˜åœ¨ï¼Œå°è¯•ä»å…¶ä»–å¯èƒ½è·¯å¾„åŠ è½½
                possible_paths = [
                    'calibration_coeffs.pt',
                    '../calibration_coeffs.pt',
                    '../../calibration_coeffs.pt',
                    'data-0815/../calibration_coeffs.pt'
                ]

                for path in possible_paths:
                    if os.path.exists(path):
                        coeffs_path = path
                        break

            if os.path.exists(coeffs_path):
                self.calibration_coeffs = torch.load(coeffs_path).to(self.device)
                print(f"âœ… AIæ ¡å‡†æ¨¡å‹åŠ è½½æˆåŠŸ: {coeffs_path}")
                print(f"   æ¨¡å‹å½¢çŠ¶: {self.calibration_coeffs.shape}")

                # æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                QtWidgets.QMessageBox.information(self, "æˆåŠŸ",
                    f"AIæ ¡å‡†æ¨¡å‹å·²åŠ è½½!\nè·¯å¾„: {coeffs_path}\nå½¢çŠ¶: {self.calibration_coeffs.shape}")

            else:
                QtWidgets.QMessageBox.warning(self, "æ–‡ä»¶æœªæ‰¾åˆ°",
                    f"æœªæ‰¾åˆ°æ ¡å‡†æ–‡ä»¶: calibration_coeffs.pt\nè¯·å…ˆè¿è¡Œæ ¡å‡†è®­ç»ƒè„šæœ¬ã€‚")
                return False

        except Exception as e:
            QtWidgets.QMessageBox.critical(self, "åŠ è½½å¤±è´¥", f"åŠ è½½AIæ ¡å‡†æ¨¡å‹å¤±è´¥:\n{str(e)}")
            return False

        return True

    def apply_ai_calibration(self, raw_data_64x64):
        """åº”ç”¨AIæ ¡å‡†åˆ°64x64åŸå§‹æ•°æ®"""
        if self.calibration_coeffs is None:
            return raw_data_64x64

        try:
            # å°†æ•°æ®è½¬æ¢ä¸ºtensor
            raw_tensor = torch.from_numpy(raw_data_64x64).float().to(self.device)

            # å±•å¹³æ•°æ®
            raw_flat = raw_tensor.view(-1)

            # åº”ç”¨æ ¡å‡†å‡½æ•°ï¼šy = a*xÂ² + b*x + c
            x = raw_flat
            a = self.calibration_coeffs[:, 0]
            b = self.calibration_coeffs[:, 1]
            c = self.calibration_coeffs[:, 2]

            calibrated_flat = a * x**2 + b * x + c

            # æ¢å¤å½¢çŠ¶
            calibrated_tensor = calibrated_flat.view(64, 64)
            calibrated_data = calibrated_tensor.cpu().numpy()

            # æ·»åŠ æ•°æ®èŒƒå›´é™åˆ¶ï¼Œé¿å…æ ¡å‡†åæ•°æ®è¿‡äºæç«¯
            raw_range = raw_data_64x64.max() - raw_data_64x64.min()
            if raw_range > 0:
                # é™åˆ¶æ ¡å‡†åæ•°æ®çš„èŒƒå›´ä¸è¶…è¿‡åŸå§‹æ•°æ®çš„5å€
                max_allowed_range = raw_range * 5
                calibrated_range = calibrated_data.max() - calibrated_data.min()
                
                if calibrated_range > max_allowed_range:
                    print(f"âš ï¸ æ ¡å‡†åæ•°æ®èŒƒå›´è¿‡å¤§: {calibrated_range:.1f} > {max_allowed_range:.1f}")
                    print(f"   åŸå§‹èŒƒå›´: {raw_range:.1f}, æ ¡å‡†åèŒƒå›´: {calibrated_range:.1f}")
                    print(f"   å°†é™åˆ¶æ ¡å‡†åæ•°æ®èŒƒå›´")
                    
                    # æ˜¾ç¤ºæ ¡å‡†ç³»æ•°ä¿¡æ¯ï¼ˆè°ƒè¯•ç”¨ï¼‰
                    coeffs_cpu = self.calibration_coeffs.cpu()
                    print(f"   æ ¡å‡†ç³»æ•°èŒƒå›´:")
                    print(f"     a: [{coeffs_cpu[:, 0].min():.4f}, {coeffs_cpu[:, 0].max():.4f}]")
                    print(f"     b: [{coeffs_cpu[:, 1].min():.4f}, {coeffs_cpu[:, 1].max():.4f}]")
                    print(f"     c: [{coeffs_cpu[:, 2].min():.4f}, {coeffs_cpu[:, 2].max():.4f}]")
                    
                    # å°†æ ¡å‡†åæ•°æ®é™åˆ¶åœ¨åˆç†èŒƒå›´å†…
                    calibrated_mean = calibrated_data.mean()
                    calibrated_data = np.clip(calibrated_data, 
                                           calibrated_mean - max_allowed_range/2,
                                           calibrated_mean + max_allowed_range/2)

            # æ»¤é™¤è´Ÿå€¼ï¼šå°†è´Ÿå€¼æ›¿æ¢ä¸º0
            negative_mask = calibrated_data < 0
            if negative_mask.any():
                negative_count = negative_mask.sum()
                print(f"âš ï¸ æ£€æµ‹åˆ° {negative_count} ä¸ªè´Ÿå€¼ï¼Œå°†å…¶æ›¿æ¢ä¸º0")
                calibrated_data[negative_mask] = 0

            # é›¶ç‚¹æ ¡æ­£ï¼šå¦‚æœåŸå§‹æ•°æ®æ¥è¿‘0ï¼Œæ ¡å‡†åä¹Ÿåº”è¯¥æ¥è¿‘0
            zero_threshold = 5.0  # è®¤ä¸ºå°äº5çš„åŸå§‹å€¼ä¸º"æ— æŒ‰å‹"
            zero_mask = raw_data_64x64 < zero_threshold
            
            if zero_mask.any():
                zero_count = zero_mask.sum()
                print(f"ğŸ”§ é›¶ç‚¹æ ¡æ­£: æ£€æµ‹åˆ° {zero_count} ä¸ªæ¥è¿‘é›¶çš„ç‚¹ï¼Œå°†å…¶æ ¡å‡†å€¼é™åˆ¶åœ¨åˆç†èŒƒå›´å†…")
                
                # å¯¹äºæ¥è¿‘é›¶çš„åŸå§‹æ•°æ®ï¼Œæ ¡å‡†åçš„å€¼ä¸åº”è¯¥è¿‡å¤§
                max_allowed_zero_value = 10.0  # å…è®¸çš„æœ€å¤§é›¶ç‚¹å€¼
                calibrated_data[zero_mask] = np.clip(calibrated_data[zero_mask], 0, max_allowed_zero_value)

            return calibrated_data

        except Exception as e:
            print(f"AIæ ¡å‡†åº”ç”¨å¤±è´¥: {e}")
            return raw_data_64x64

    def show_ai_calibration_info(self):
        """æ˜¾ç¤ºAIæ ¡å‡†ä¿¡æ¯"""
        if self.calibration_coeffs is None:
            QtWidgets.QMessageBox.information(self, "AIæ ¡å‡†ä¿¡æ¯",
                "AIæ ¡å‡†æ¨¡å‹å°šæœªåŠ è½½ã€‚\n\nè¯·å…ˆé€šè¿‡èœå•é€‰æ‹©'åŠ è½½AIæ ¡å‡†æ¨¡å‹'æ¥åŠ è½½æ ¡å‡†æ–‡ä»¶ã€‚")
            return

        # è·å–æ¨¡å‹ä¿¡æ¯
        model_shape = self.calibration_coeffs.shape
        device_info = str(self.device)

        # è®¡ç®—ç³»æ•°ç»Ÿè®¡ä¿¡æ¯
        coeffs_cpu = self.calibration_coeffs.cpu()
        a_stats = coeffs_cpu[:, 0]
        b_stats = coeffs_cpu[:, 1]
        c_stats = coeffs_cpu[:, 2]

        info_text = f"""
AIæ ¡å‡†æ¨¡å‹ä¿¡æ¯

ğŸ“Š æ¨¡å‹åŸºæœ¬ä¿¡æ¯:
â€¢ æ¨¡å‹æ–‡ä»¶: calibration_coeffs.pt
â€¢ æ¨¡å‹å½¢çŠ¶: {model_shape}
â€¢ è®¡ç®—è®¾å¤‡: {device_info}
â€¢ ä¼ æ„Ÿå™¨æ•°é‡: {model_shape[0]} (64x64 = {64*64})

ğŸ”¬ æ ¡å‡†ç³»æ•°ç»Ÿè®¡:

äºŒæ¬¡é¡¹ç³»æ•° (a):
â€¢ èŒƒå›´: [{a_stats.min():.4f}, {a_stats.max():.4f}]
â€¢ å‡å€¼: {a_stats.mean():.4f}
â€¢ æ ‡å‡†å·®: {a_stats.std():.4f}

ä¸€æ¬¡é¡¹ç³»æ•° (b):
â€¢ èŒƒå›´: [{b_stats.min():.4f}, {b_stats.max():.4f}]
â€¢ å‡å€¼: {b_stats.mean():.4f}
â€¢ æ ‡å‡†å·®: {b_stats.std():.4f}

å¸¸æ•°é¡¹ç³»æ•° (c):
â€¢ èŒƒå›´: [{c_stats.min():.4f}, {c_stats.max():.4f}]
â€¢ å‡å€¼: {c_stats.mean():.4f}
â€¢ æ ‡å‡†å·®: {c_stats.std():.4f}

âš™ï¸ æ ¡å‡†å…¬å¼:
å¯¹äºæ¯ä¸ªä¼ æ„Ÿå™¨ç‚¹ (i,j):
æ ¡å‡†åå€¼ = aáµ¢â±¼ Ã— (åŸå§‹å€¼)Â² + báµ¢â±¼ Ã— (åŸå§‹å€¼) + cáµ¢â±¼

ğŸ¯ æ ¡å‡†ç›®æ ‡:
â€¢ å‡å°‘ä¼ æ„Ÿå™¨é—´çš„å“åº”å·®å¼‚
â€¢ æ”¹å–„æ•´ä½“CV (å˜å¼‚ç³»æ•°)
â€¢ æé«˜æ•°æ®å‡åŒ€æ€§
"""

        QtWidgets.QMessageBox.information(self, "AIæ ¡å‡†ä¿¡æ¯", info_text)

    def __show_calibration_comparison(self):
        """æ˜¾ç¤ºæ ¡å‡†å‰åå¯¹æ¯”"""
        if self.calibration_coeffs is None:
            QtWidgets.QMessageBox.warning(self, "æœªåŠ è½½", "è¯·å…ˆåŠ è½½AIæ ¡å‡†æ¨¡å‹")
            return

        # åˆ›å»ºå®æ—¶å¯¹æ¯”å¯¹è¯æ¡†
        dialog = RealtimeCalibrationDialog(self)
        dialog.show()  # ä½¿ç”¨show()è€Œä¸æ˜¯exec_()ï¼Œè¿™æ ·ä¸ä¼šé˜»å¡ä¸»ç•Œé¢
        
    def __show_detailed_calibration_comparison(self):
        """æ˜¾ç¤ºè¯¦ç»†æ ¡å‡†å¯¹æ¯”"""
        if self.calibration_coeffs is None:
            QtWidgets.QMessageBox.warning(self, "æœªåŠ è½½", "è¯·å…ˆåŠ è½½AIæ ¡å‡†æ¨¡å‹")
            return

        # åˆ›å»ºè¯¦ç»†å¯¹æ¯”å¯¹è¯æ¡†
        dialog = CalibrationComparisonDialog(self)
        dialog.exec_()

    def get_current_frame_data(self):
        """è·å–å½“å‰å¸§çš„åŸå§‹æ•°æ®ï¼ˆç”¨äºæ ¡å‡†å¯¹æ¯”ï¼‰"""
        # ä¼˜å…ˆä»data_handlerè·å–æœ€æ–°çš„å®æ—¶åŸå§‹æ•°æ®
        if len(self.data_handler.data) > 0:
            print("âœ… ä½¿ç”¨data_handler.dataçš„å®æ—¶åŸå§‹æ•°æ®")
            return self.data_handler.data[-1]
        elif len(self.data_handler.value_before_zero) > 0:
            # å¦‚æœdataä¸ºç©ºï¼Œå°è¯•ä»value_before_zeroè·å–åŸå§‹æ•°æ®
            print("âœ… ä½¿ç”¨value_before_zeroçš„åŸå§‹æ•°æ®")
            return self.data_handler.value_before_zero[-1]
        elif hasattr(self, '_raw_data_for_comparison') and len(self._raw_data_for_comparison) > 0:
            # æœ€åæ‰ä½¿ç”¨ä¿å­˜çš„åŸå§‹æ•°æ®å‰¯æœ¬
            print("âš ï¸ ä½¿ç”¨ä¿å­˜çš„åŸå§‹æ•°æ®å‰¯æœ¬")
            return self._raw_data_for_comparison[-1]
        elif len(self.data_handler.value) > 0:
            # æœ€åä»valueè·å–ï¼ˆå¯èƒ½å·²ç»æ˜¯æ ¡å‡†åçš„æ•°æ®ï¼‰
            print("âš ï¸ ä½¿ç”¨å¯èƒ½å·²æ ¡å‡†çš„æ•°æ®ä½œä¸ºåŸå§‹æ•°æ®")
            return self.data_handler.value[-1]
        else:
            # å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œè¿”å›æ¨¡æ‹Ÿæ•°æ®
            print("âš ï¸ æ²¡æœ‰å®æ—¶æ•°æ®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®")
            return np.random.rand(64, 64) * 1000

    def setup_calibration_menu(self):
        """è®¾ç½®æ ¡å‡†èœå•"""
        try:
            print("ğŸ”§ è®¾ç½®AIæ ¡å‡†èœå•...")
            # æ£€æŸ¥menubaræ˜¯å¦å­˜åœ¨
            if not hasattr(self, 'menubar') or self.menubar is None:
                print("âŒ èœå•æ ä¸å­˜åœ¨")
                return

            # åˆ›å»ºæ ¡å‡†èœå•
            calibration_menu = self.menubar.addMenu('AIæ ¡å‡†')
            print("âœ… AIæ ¡å‡†èœå•å·²åˆ›å»º")

            # åŠ è½½AIæ ¡å‡†æ¨¡å‹
            load_action = QtWidgets.QAction('åŠ è½½AIæ ¡å‡†æ¨¡å‹', self)
            load_action.triggered.connect(self.__load_ai_calibration)
            calibration_menu.addAction(load_action)

            # å®æ—¶æ ¡å‡†å¯¹æ¯”
            realtime_compare_action = QtWidgets.QAction('å®æ—¶æ ¡å‡†å¯¹æ¯”', self)
            realtime_compare_action.triggered.connect(self.__show_calibration_comparison)
            calibration_menu.addAction(realtime_compare_action)
            
            # è¯¦ç»†æ ¡å‡†å¯¹æ¯”ï¼ˆåŸæœ‰åŠŸèƒ½ï¼‰
            compare_action = QtWidgets.QAction('è¯¦ç»†æ ¡å‡†å¯¹æ¯”', self)
            compare_action.triggered.connect(self.__show_detailed_calibration_comparison)
            calibration_menu.addAction(compare_action)

            calibration_menu.addSeparator()

            # AIæ ¡å‡†ä¿¡æ¯
            info_action = QtWidgets.QAction('AIæ ¡å‡†ä¿¡æ¯', self)
            info_action.triggered.connect(self.show_ai_calibration_info)
            calibration_menu.addAction(info_action)

            # å¯ç”¨èœå•æ 
            self.menubar.setEnabled(True)
            # æ˜¾ç¤ºèœå•æ 
            self.menubar.show()
            # å¼ºåˆ¶è®¾ç½®èœå•æ å¯è§
            self.menubar.setVisible(True)
            
            # å°è¯•å…¶ä»–æ–¹æ³•è®¾ç½®èœå•æ å¯è§
            self.menubar.setHidden(False)
            self.menubar.raise_()
            
            print("âœ… AIæ ¡å‡†èœå•è®¾ç½®å®Œæˆ")

        except Exception as e:
            print(f"âŒ è®¾ç½®AIæ ¡å‡†èœå•å¤±è´¥: {e}")
            import traceback
            traceback.print_exc()
            
    def _ensure_menubar_visible(self):
        """ç¡®ä¿èœå•æ å¯è§"""
        try:
            if hasattr(self, 'menubar') and self.menubar is not None:
                self.menubar.setVisible(True)
                self.menubar.setHidden(False)
                self.menubar.raise_()
                print("ğŸ”§ å»¶è¿Ÿè®¾ç½®èœå•æ å¯è§")
        except Exception as e:
            print(f"âš ï¸ å»¶è¿Ÿè®¾ç½®èœå•æ å¯è§å¤±è´¥: {e}")
            
    def __show_ai_calibration_menu(self):
        """æ˜¾ç¤ºAIæ ¡å‡†èœå•ï¼ˆé€šè¿‡æŒ‰é’®è§¦å‘ï¼‰"""
        try:
            from PyQt5 import QtWidgets
            
            # åˆ›å»ºAIæ ¡å‡†èœå•
            menu = QtWidgets.QMenu(self)
            menu.setTitle("AIæ ¡å‡†")
            
            # æ·»åŠ èœå•é¡¹
            load_action = menu.addAction("åŠ è½½AIæ ¡å‡†æ¨¡å‹")
            load_action.triggered.connect(self.__load_ai_calibration)
            
            compare_action = menu.addAction("æ˜¾ç¤ºæ ¡å‡†å¯¹æ¯”")
            compare_action.triggered.connect(self.__show_calibration_comparison)
            
            menu.addSeparator()
            
            info_action = menu.addAction("AIæ ¡å‡†ä¿¡æ¯")
            info_action.triggered.connect(self.show_ai_calibration_info)
            
            # åœ¨æŒ‰é’®ä½ç½®æ˜¾ç¤ºèœå•
            button_pos = self.button_ai_calibration.mapToGlobal(self.button_ai_calibration.rect().bottomLeft())
            menu.exec_(button_pos)
            
        except Exception as e:
            print(f"âŒ æ˜¾ç¤ºAIæ ¡å‡†èœå•å¤±è´¥: {e}")
            import traceback
            traceback.print_exc()

# ==================== å®æ—¶æ ¡å‡†å¯¹æ¯”å¯¹è¯æ¡† ====================

class RealtimeCalibrationDialog(QtWidgets.QDialog):
    """å®æ—¶æ ¡å‡†å‰åå¯¹æ¯”å¯¹è¯æ¡†"""
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.parent = parent
        self.setWindowTitle("AIæ ¡å‡†å®æ—¶å¯¹æ¯”")
        self.setGeometry(200, 200, 1000, 600)
        
        # è®¾ç½®ä¸­æ–‡å­—ä½“
        plt.rcParams['font.sans-serif'] = ['SimHei', 'Microsoft YaHei', 'DejaVu Sans']
        plt.rcParams['axes.unicode_minus'] = False
        
        # è®¾ç½®å®æ—¶æ›´æ–°å®šæ—¶å™¨
        self.update_timer = QtCore.QTimer()
        self.update_timer.timeout.connect(self.update_comparison)
        self.update_timer.start(500)  # æ¯500msæ›´æ–°ä¸€æ¬¡ï¼Œå‡å°‘CPUå ç”¨
        
        # æ·»åŠ æ•°æ®å˜åŒ–æ£€æµ‹
        self._last_raw_data = None
        self._update_count = 0
        
        self.setup_ui()
        
    def setup_ui(self):
        """è®¾ç½®ç”¨æˆ·ç•Œé¢"""
        layout = QtWidgets.QVBoxLayout()
        
        # æ ‡é¢˜
        title = QtWidgets.QLabel("AIæ ¡å‡†å®æ—¶å¯¹æ¯” - æ ¡å‡†å‰ vs æ ¡å‡†å")
        title.setStyleSheet("font-size: 16px; font-weight: bold; text-align: center;")
        layout.addWidget(title)
        
        # åˆ›å»ºä¸¤ä¸ªçƒ­åŠ›å›¾çš„å¸ƒå±€
        heatmap_layout = QtWidgets.QHBoxLayout()
        
        # å·¦ä¾§ï¼šæ ¡å‡†å‰çƒ­åŠ›å›¾
        self.raw_canvas = self.create_heatmap_canvas("æ ¡å‡†å‰ - åŸå§‹æ•°æ®")
        heatmap_layout.addWidget(self.raw_canvas)
        
        # å³ä¾§ï¼šæ ¡å‡†åçƒ­åŠ›å›¾
        self.calibrated_canvas = self.create_heatmap_canvas("æ ¡å‡†å - AIæ ¡å‡†æ•°æ®")
        heatmap_layout.addWidget(self.calibrated_canvas)
        
        layout.addLayout(heatmap_layout)
        
        # ç»Ÿè®¡ä¿¡æ¯
        self.stats_label = QtWidgets.QLabel("ç»Ÿè®¡ä¿¡æ¯åŠ è½½ä¸­...")
        self.stats_label.setStyleSheet("font-family: 'Microsoft YaHei'; font-size: 12px; padding: 10px;")
        layout.addWidget(self.stats_label)
        
        # æŒ‰é’®åŒºåŸŸ
        button_layout = QtWidgets.QHBoxLayout()
        
        # å¼ºåˆ¶åˆ·æ–°æŒ‰é’®
        refresh_btn = QtWidgets.QPushButton("å¼ºåˆ¶åˆ·æ–°")
        refresh_btn.clicked.connect(self.force_refresh)
        button_layout.addWidget(refresh_btn)
        
        close_btn = QtWidgets.QPushButton("å…³é—­")
        close_btn.clicked.connect(self.close)
        button_layout.addWidget(close_btn)
        
        layout.addLayout(button_layout)
        self.setLayout(layout)
        
    def create_heatmap_canvas(self, title):
        """åˆ›å»ºçƒ­åŠ›å›¾ç”»å¸ƒ"""
        # åˆ›å»ºmatplotlibå›¾å½¢
        fig = plt.figure(figsize=(6, 5))
        ax = fig.add_subplot(111)
        
        # åˆ›å»ºåˆå§‹çƒ­åŠ›å›¾ï¼ˆç©ºæ•°æ®ï¼‰
        im = ax.imshow(np.zeros((64, 64)), cmap='viridis', aspect='equal')
        ax.set_title(title)
        plt.colorbar(im, ax=ax, shrink=0.8)
        
        # å°†matplotlibå›¾å½¢è½¬æ¢ä¸ºQt widget
        canvas = FigureCanvas(fig)
        canvas.setMinimumSize(400, 300)
        
        return canvas
        
    def update_comparison(self):
        """å®æ—¶æ›´æ–°å¯¹æ¯”æ•°æ®"""
        try:
            # è·å–å½“å‰æ•°æ®
            raw_data = self.parent.get_current_frame_data()
            
            # æ£€æŸ¥æ•°æ®æ˜¯å¦çœŸçš„åœ¨å˜åŒ–
            if hasattr(self, '_last_raw_data'):
                if np.array_equal(raw_data, self._last_raw_data):
                    print("âš ï¸ åŸå§‹æ•°æ®æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æ›´æ–°")
                    return
            self._last_raw_data = raw_data.copy()
            
            calibrated_data = self.parent.apply_ai_calibration(raw_data)
            
            self._update_count += 1
            print(f"ğŸ”„ æ›´æ–°å¯¹æ¯”æ•°æ® #{self._update_count} - åŸå§‹èŒƒå›´:[{raw_data.min():.1f},{raw_data.max():.1f}], æ ¡å‡†åèŒƒå›´:[{calibrated_data.min():.1f},{calibrated_data.max():.1f}]")
            
            # æ›´æ–°åŸå§‹æ•°æ®çƒ­åŠ›å›¾
            raw_fig = self.raw_canvas.figure
            raw_ax = raw_fig.axes[0]
            raw_im = raw_ax.images[0]
            raw_im.set_array(raw_data)
            raw_im.set_clim(raw_data.min(), raw_data.max())
            raw_fig.canvas.draw()
            
            # æ›´æ–°æ ¡å‡†åæ•°æ®çƒ­åŠ›å›¾
            cal_fig = self.calibrated_canvas.figure
            cal_ax = cal_fig.axes[0]
            cal_im = cal_ax.images[0]
            cal_im.set_array(calibrated_data)
            
            # ä½¿ç”¨top99%èŒƒå›´ï¼Œé¿å…å¼‚å¸¸å€¼å½±å“
            cal_data_flat = calibrated_data.flatten()
            cal_99_percentile = np.percentile(cal_data_flat, 99)
            cal_1_percentile = np.percentile(cal_data_flat, 1)
            
            # è®¾ç½®é¢œè‰²èŒƒå›´ï¼šä»1%åˆ°99%åˆ†ä½æ•°
            cal_im.set_clim(cal_1_percentile, cal_99_percentile)
            cal_fig.canvas.draw()
            
            # æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            # é¿å…é™¤é›¶é”™è¯¯ï¼Œä½¿ç”¨æ›´å®‰å…¨çš„CVè®¡ç®—
            raw_mean = raw_data.mean()
            raw_std = raw_data.std()
            cal_mean = calibrated_data.mean()
            cal_std = calibrated_data.std()
            
            # è®¡ç®—CVï¼ˆå˜å¼‚ç³»æ•°ï¼‰
            cv_raw = raw_std / abs(raw_mean) if abs(raw_mean) > 1e-6 else 0
            cv_cal = cal_std / abs(cal_mean) if abs(cal_mean) > 1e-6 else 0
            
            # è®¡ç®—CVæ”¹å–„å€æ•°
            if cv_cal > 1e-6 and cv_raw > 1e-6:
                cv_improvement = cv_raw / cv_cal
            else:
                cv_improvement = 1.0
            
            # è®¡ç®—åˆ†ä½æ•°ä¿¡æ¯
            cal_data_flat = calibrated_data.flatten()
            cal_99_percentile = np.percentile(cal_data_flat, 99)
            cal_1_percentile = np.percentile(cal_data_flat, 1)
            cal_95_percentile = np.percentile(cal_data_flat, 95)
            cal_5_percentile = np.percentile(cal_data_flat, 5)
            
            stats_text = f"""
            ğŸ“Š å®æ—¶ç»Ÿè®¡ä¿¡æ¯
            
            åŸå§‹æ•°æ®: å‡å€¼={raw_mean:.1f}, æ ‡å‡†å·®={raw_std:.1f}, CV={cv_raw:.3f}
            æ ¡å‡†å: å‡å€¼={cal_mean:.1f}, æ ‡å‡†å·®={cal_std:.1f}, CV={cv_cal:.3f}
            CVæ”¹å–„å€æ•°: {cv_improvement:.1f}å€
            
            ğŸ” æ•°æ®çŠ¶æ€:
            åŸå§‹æ•°æ®èŒƒå›´: [{raw_data.min():.1f}, {raw_data.max():.1f}]
            æ ¡å‡†åèŒƒå›´: [{calibrated_data.min():.1f}, {calibrated_data.max():.1f}]
            æ ¡å‡†ååˆ†ä½æ•°: 1%={cal_1_percentile:.1f}, 5%={cal_5_percentile:.1f}, 95%={cal_95_percentile:.1f}, 99%={cal_99_percentile:.1f}
            çƒ­åŠ›å›¾èŒƒå›´: [{cal_1_percentile:.1f}, {cal_99_percentile:.1f}] (é¿å…å¼‚å¸¸å€¼)
            æ•°æ®æ¥æº: {'å®æ—¶ä¼ æ„Ÿå™¨æ•°æ®' if len(self.parent.data_handler.data) > 0 else 'ç¼“å­˜æ•°æ®'}
            """
            
            self.stats_label.setText(stats_text)
            
        except Exception as e:
            print(f"âš ï¸ æ›´æ–°å¯¹æ¯”æ•°æ®å¤±è´¥: {e}")
            
    def force_refresh(self):
        """å¼ºåˆ¶åˆ·æ–°å¯¹æ¯”æ•°æ®"""
        try:
            print("ğŸ”§ å¼ºåˆ¶åˆ·æ–°å¯¹æ¯”æ•°æ®...")
            # æ¸…é™¤ä¸Šæ¬¡æ•°æ®ç¼“å­˜ï¼Œå¼ºåˆ¶æ›´æ–°
            self._last_raw_data = None
            self._update_count = 0
            # ç«‹å³æ›´æ–°ä¸€æ¬¡
            self.update_comparison()
            print("âœ… å¼ºåˆ¶åˆ·æ–°å®Œæˆ")
        except Exception as e:
            print(f"âŒ å¼ºåˆ¶åˆ·æ–°å¤±è´¥: {e}")
            
    def closeEvent(self, event):
        """å…³é—­äº‹ä»¶"""
        if hasattr(self, 'update_timer'):
            self.update_timer.stop()
        super().closeEvent(event)

# ==================== åŸæœ‰æ ¡å‡†å¯¹æ¯”å¯¹è¯æ¡† ====================

class CalibrationComparisonDialog(QtWidgets.QDialog):
    """æ ¡å‡†å‰åå¯¹æ¯”å¯¹è¯æ¡†ï¼ˆåŸæœ‰ç‰ˆæœ¬ï¼‰"""

    def __init__(self, parent=None):
        super().__init__(parent)
        self.parent = parent
        self.setWindowTitle("AIæ ¡å‡†å‰åå¯¹æ¯”")
        self.setGeometry(200, 200, 1200, 800)

        # è®¾ç½®ä¸­æ–‡å­—ä½“
        plt.rcParams['font.sans-serif'] = ['SimHei', 'Microsoft YaHei', 'DejaVu Sans']
        plt.rcParams['axes.unicode_minus'] = False

        # è®¾ç½®è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨
        self.auto_refresh_timer = QtCore.QTimer()
        self.auto_refresh_timer.timeout.connect(self.refresh_data)
        self.auto_refresh_enabled = False

        self.setup_ui()

    def setup_ui(self):
        """è®¾ç½®ç”¨æˆ·ç•Œé¢"""
        layout = QtWidgets.QVBoxLayout()

        # æ ‡é¢˜
        title = QtWidgets.QLabel("AIæ ¡å‡†å‰åå¯¹æ¯”åˆ†æ")
        title.setStyleSheet("font-size: 16px; font-weight: bold;")
        layout.addWidget(title)

        # åˆ›å»ºæ»šåŠ¨åŒºåŸŸ
        scroll_area = QtWidgets.QScrollArea()
        scroll_widget = QtWidgets.QWidget()
        scroll_layout = QtWidgets.QVBoxLayout(scroll_widget)

        # è·å–å½“å‰å¸§æ•°æ®
        raw_data = self.parent.get_current_frame_data()
        calibrated_data = self.parent.apply_ai_calibration(raw_data)

        # åˆ›å»ºå¯¹æ¯”å›¾
        self.create_comparison_plots(scroll_layout, raw_data, calibrated_data)

        # æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
        self.add_statistics_info(scroll_layout, raw_data, calibrated_data)

        scroll_widget.setLayout(scroll_layout)
        scroll_area.setWidget(scroll_widget)
        scroll_area.setWidgetResizable(True)
        layout.addWidget(scroll_area)

        # æŒ‰é’®åŒºåŸŸ
        button_layout = QtWidgets.QHBoxLayout()

        refresh_btn = QtWidgets.QPushButton("æ‰‹åŠ¨åˆ·æ–°")
        refresh_btn.clicked.connect(self.refresh_data)
        button_layout.addWidget(refresh_btn)
        
        # è‡ªåŠ¨åˆ·æ–°åˆ‡æ¢æŒ‰é’®
        self.auto_refresh_btn = QtWidgets.QPushButton("å¼€å¯è‡ªåŠ¨åˆ·æ–°")
        self.auto_refresh_btn.clicked.connect(self.toggle_auto_refresh)
        button_layout.addWidget(self.auto_refresh_btn)

        save_btn = QtWidgets.QPushButton("ä¿å­˜å¯¹æ¯”å›¾")
        save_btn.clicked.connect(self.save_comparison)
        button_layout.addWidget(save_btn)

        close_btn = QtWidgets.QPushButton("å…³é—­")
        close_btn.clicked.connect(self.close)
        button_layout.addWidget(close_btn)

        layout.addLayout(button_layout)
        self.setLayout(layout)

    def create_comparison_plots(self, layout, raw_data, calibrated_data):
        """åˆ›å»ºå¯¹æ¯”å›¾"""
        # åˆ›å»ºmatplotlibå›¾å½¢
        fig = plt.figure(figsize=(15, 10))

        # 1. åŸå§‹æ•°æ®çƒ­åŠ›å›¾
        ax1 = fig.add_subplot(2, 3, 1)
        im1 = ax1.imshow(raw_data, cmap='viridis', aspect='equal')
        ax1.set_title('åŸå§‹æ•°æ®çƒ­åŠ›å›¾')
        plt.colorbar(im1, ax=ax1, shrink=0.8)

        # 2. æ ¡å‡†åæ•°æ®çƒ­åŠ›å›¾
        ax2 = fig.add_subplot(2, 3, 2)
        
        # ä½¿ç”¨top99%èŒƒå›´ï¼Œé¿å…å¼‚å¸¸å€¼å½±å“
        cal_data_flat = calibrated_data.flatten()
        cal_99_percentile = np.percentile(cal_data_flat, 99)
        cal_1_percentile = np.percentile(cal_data_flat, 1)
        
        im2 = ax2.imshow(calibrated_data, cmap='viridis', aspect='equal', 
                         vmin=cal_1_percentile, vmax=cal_99_percentile)
        ax2.set_title('æ ¡å‡†åçƒ­åŠ›å›¾ (1%-99%èŒƒå›´)')
        plt.colorbar(im2, ax=ax2, shrink=0.8)

        # 3. å·®å¼‚çƒ­åŠ›å›¾
        ax3 = fig.add_subplot(2, 3, 3)
        diff = calibrated_data - raw_data.mean()
        im3 = ax3.imshow(diff, cmap='RdBu_r', aspect='equal')
        ax3.set_title('æ ¡å‡†è°ƒæ•´é‡çƒ­åŠ›å›¾')
        plt.colorbar(im3, ax=ax3, shrink=0.8)

        # 4. åŸå§‹æ•°æ®ç›´æ–¹å›¾
        ax4 = fig.add_subplot(2, 3, 4)
        ax4.hist(raw_data.flatten(), bins=50, alpha=0.7, label='åŸå§‹æ•°æ®', density=True)
        ax4.axvline(raw_data.mean(), color='red', linestyle='--', linewidth=2,
                   label=f'å‡å€¼: {raw_data.mean():.1f}')
        ax4.set_title('åŸå§‹æ•°æ®åˆ†å¸ƒç›´æ–¹å›¾')
        ax4.set_xlabel('å“åº”å€¼')
        ax4.set_ylabel('å¯†åº¦')
        ax4.legend()
        ax4.grid(True, alpha=0.3)

        # 5. æ ¡å‡†åæ•°æ®ç›´æ–¹å›¾
        ax5 = fig.add_subplot(2, 3, 5)
        ax5.hist(calibrated_data.flatten(), bins=50, alpha=0.7, color='orange',
                label='æ ¡å‡†åæ•°æ®', density=True)
        ax5.axvline(calibrated_data.mean(), color='blue', linestyle='--', linewidth=2,
                   label=f'å‡å€¼: {calibrated_data.mean():.1f}')
        ax5.set_title('æ ¡å‡†åæ•°æ®åˆ†å¸ƒç›´æ–¹å›¾')
        ax5.set_xlabel('å“åº”å€¼')
        ax5.set_ylabel('å¯†åº¦')
        ax5.legend()
        ax5.grid(True, alpha=0.3)

        # 6. æ•£ç‚¹å›¾å¯¹æ¯”
        ax6 = fig.add_subplot(2, 3, 6)
        sample_indices = np.random.choice(64*64, size=min(1000, 64*64), replace=False)
        raw_sample = raw_data.flatten()[sample_indices]
        cal_sample = calibrated_data.flatten()[sample_indices]

        ax6.scatter(raw_sample, cal_sample, alpha=0.6, s=2, color='purple')
        ax6.plot([raw_data.min(), raw_data.max()], [raw_data.min(), raw_data.max()],
                'r--', linewidth=2, label='å¯¹è§’çº¿')
        ax6.set_xlabel('åŸå§‹å“åº”')
        ax6.set_ylabel('æ ¡å‡†åå“åº”')
        ax6.set_title('åŸå§‹vsæ ¡å‡†åå“åº”æ•£ç‚¹å›¾')
        ax6.legend()
        ax6.grid(True, alpha=0.3)

        plt.suptitle('AIæ ¡å‡†å‰åå¯¹æ¯”åˆ†æ', fontsize=16, fontweight='bold')
        plt.tight_layout()

        # å°†matplotlibå›¾å½¢è½¬æ¢ä¸ºQt widget
        canvas = FigureCanvas(fig)
        layout.addWidget(canvas)

    def add_statistics_info(self, layout, raw_data, calibrated_data):
        """æ·»åŠ ç»Ÿè®¡ä¿¡æ¯"""
        stats_group = QtWidgets.QGroupBox("ç»Ÿè®¡ä¿¡æ¯å¯¹æ¯”")
        stats_layout = QtWidgets.QVBoxLayout()

        # è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡
        cv_raw = raw_data.std() / raw_data.mean()
        cv_cal = calibrated_data.std() / calibrated_data.mean()
        cv_improvement = cv_raw / cv_cal
        std_improvement = raw_data.std() / calibrated_data.std()
        
        # è®¡ç®—åˆ†ä½æ•°æŒ‡æ ‡
        cal_data_flat = calibrated_data.flatten()
        cal_99_percentile = np.percentile(cal_data_flat, 99)
        cal_1_percentile = np.percentile(cal_data_flat, 1)
        cal_95_percentile = np.percentile(cal_data_flat, 95)
        cal_5_percentile = np.percentile(cal_data_flat, 5)

        # åˆ›å»ºç»Ÿè®¡ä¿¡æ¯æ–‡æœ¬
        stats_text = f"""
        ğŸ“Š æ ¡å‡†æ•ˆæœç»Ÿè®¡

        åŸå§‹æ•°æ®:
        â€¢ å‡å€¼: {raw_data.mean():.1f}
        â€¢ æ ‡å‡†å·®: {raw_data.std():.1f}
        â€¢ CV (å˜å¼‚ç³»æ•°): {cv_raw:.3f}
        â€¢ èŒƒå›´: [{raw_data.min():.1f}, {raw_data.max():.1f}]

        æ ¡å‡†å:
        â€¢ å‡å€¼: {calibrated_data.mean():.1f}
        â€¢ æ ‡å‡†å·®: {calibrated_data.std():.1f}
        â€¢ CV (å˜å¼‚ç³»æ•°): {cv_cal:.3f}
        â€¢ èŒƒå›´: [{calibrated_data.min():.1f}, {calibrated_data.max():.1f}]
        â€¢ åˆ†ä½æ•°: 1%={cal_1_percentile:.1f}, 5%={cal_5_percentile:.1f}, 95%={cal_95_percentile:.1f}, 99%={cal_99_percentile:.1f}
        â€¢ çƒ­åŠ›å›¾èŒƒå›´: [{cal_1_percentile:.1f}, {cal_99_percentile:.1f}] (é¿å…å¼‚å¸¸å€¼)

        æ”¹å–„æ•ˆæœ:
        â€¢ CVæ”¹å–„å€æ•°: {cv_improvement:.1f}å€
        â€¢ æ ‡å‡†å·®æ”¹å–„å€æ•°: {std_improvement:.1f}å€
        â€¢ å‡åŒ€æ€§æå‡: {((cv_raw - cv_cal) / cv_raw * 100):.1f}%

        ğŸ¯ ç»“è®º:
        â€¢ æ ¡å‡†æ˜¾è‘—æ”¹å–„äº†ä¼ æ„Ÿå™¨çš„ä¸€è‡´æ€§
        â€¢ å˜å¼‚ç³»æ•°é™ä½äº†{cv_improvement:.1f}å€
        â€¢ æ ‡å‡†å·®é™ä½äº†{std_improvement:.1f}å€
        """

        stats_label = QtWidgets.QLabel(stats_text)
        stats_label.setStyleSheet("font-family: 'Microsoft YaHei'; font-size: 12px;")
        stats_layout.addWidget(stats_label)

        stats_group.setLayout(stats_layout)
        layout.addWidget(stats_group)

    def toggle_auto_refresh(self):
        """åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°"""
        if self.auto_refresh_enabled:
            # åœæ­¢è‡ªåŠ¨åˆ·æ–°
            self.auto_refresh_timer.stop()
            self.auto_refresh_enabled = False
            self.auto_refresh_btn.setText("å¼€å¯è‡ªåŠ¨åˆ·æ–°")
            print("â¸ï¸ å·²åœæ­¢è‡ªåŠ¨åˆ·æ–°")
        else:
            # å¼€å¯è‡ªåŠ¨åˆ·æ–°ï¼Œæ¯2ç§’åˆ·æ–°ä¸€æ¬¡
            self.auto_refresh_timer.start(2000)
            self.auto_refresh_enabled = True
            self.auto_refresh_btn.setText("åœæ­¢è‡ªåŠ¨åˆ·æ–°")
            print("â–¶ï¸ å·²å¼€å¯è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯2ç§’ï¼‰")

    def refresh_data(self):
        """åˆ·æ–°æ•°æ®"""
        try:
            print("ğŸ”„ åˆ·æ–°æ ¡å‡†å¯¹æ¯”æ•°æ®...")
            # é‡æ–°è·å–æ•°æ®å¹¶æ›´æ–°æ˜¾ç¤º
            self.setup_ui()
            print("âœ… æ ¡å‡†å¯¹æ¯”æ•°æ®å·²åˆ·æ–°")
        except Exception as e:
            print(f"âŒ åˆ·æ–°æ ¡å‡†å¯¹æ¯”æ•°æ®å¤±è´¥: {e}")
            import traceback
            traceback.print_exc()
            
    def closeEvent(self, event):
        """å…³é—­äº‹ä»¶"""
        if hasattr(self, 'auto_refresh_timer'):
            self.auto_refresh_timer.stop()
        super().closeEvent(event)

    def save_comparison(self):
        """ä¿å­˜å¯¹æ¯”å›¾"""
        file_path, _ = QtWidgets.QFileDialog.getSaveFileName(
            self, "ä¿å­˜å¯¹æ¯”å›¾", "", "PNGæ–‡ä»¶ (*.png);;PDFæ–‡ä»¶ (*.pdf)"
        )

        if file_path:
            try:
                # è¿™é‡Œå¯ä»¥å®ç°ä¿å­˜å½“å‰å¯¹æ¯”å›¾çš„åŠŸèƒ½
                QtWidgets.QMessageBox.information(self, "ä¿å­˜æˆåŠŸ", f"å¯¹æ¯”å›¾å·²ä¿å­˜åˆ°:\n{file_path}")
            except Exception as e:
                QtWidgets.QMessageBox.critical(self, "ä¿å­˜å¤±è´¥", f"ä¿å­˜å¤±è´¥:\n{str(e)}")

def start(mode='standard'):
    app = QtWidgets.QApplication(sys.argv)
    w = Window(mode)
    w.show()
    w.trigger_null()
    sys.exit(app.exec_())
